<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Sayƒ±m Giri≈üi (Emir {{ sayim_emri.pk }})</title>

    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

    <style>
        /* --------------------------------- */
        /* TEMEL CSS VE YENƒ∞ BARKOD STƒ∞LLERƒ∞ */
        /* --------------------------------- */
        body { font-family: 'Arial', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 1.1em; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1.2em; }
        #kaydet-btn { background-color: #28a745; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.4em; width: 100%; margin-top: 25px; }
        .info-box { padding: 10px; margin-top: 10px; border-radius: 5px; }
        #urun-bilgi-label { background-color: #e9ecef; color: #495057; font-size: 1em; }
        #last-sayim-label { background-color: #fff3cd; color: #856404; font-size: 0.9em; }
        #message-box { margin-top: 15px; padding: 15px; border-radius: 6px; font-weight: bold; display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        
        /* BARKOD TARAYICI STƒ∞LLERƒ∞ */
        #interactive.viewport {
            position: relative;
            margin-top: 15px;
            width: 100%;
            height: 300px; 
            overflow: hidden;
            border: 2px solid #007bff;
            border-radius: 8px;
            display: none; 
        }

        #interactive.viewport canvas, #interactive.viewport video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        .barcode-overlay-info {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0, 123, 255, 0.8);
            color: white;
            padding: 5px;
            text-align: center;
            font-weight: bold;
            z-index: 10;
        }
        #barcode-scanner-btn {
            background-color: #007bff; /* Mavi */
            color: white;
            padding: 10px;
            border: none;
            border-radius: 6px;
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Stok Sayƒ±m Giri≈üi</h1>
        <p>**PERSONEL**: <span id="personel-adi">{{ personel_adi }}</span> | **DEPO**: <span id="depo-kodu">{{ depo_kodu }}</span></p>
        <h2 style="color: darkred;">Emir: {{ sayim_emri.ad }} (ID: {{ sayim_emri.pk }})</h2>

        <div style="margin-bottom: 20px;">
            <a href="{% url 'raporlama_onay' sayim_emri.pk %}" 
               style="background-color: #007bff; color: white; padding: 8px 15px; border-radius: 6px; text-decoration: none; display: inline-block;">
                Raporlama ve Onay Ekranƒ±na Git
            </a>
        </div>
        
        <div id="message-box" class="info-box"></div>
        
        <input type="hidden" id="id_seri_no" name="seri_no" value="">

        <div style="margin-top: 20px;">
            <button type="button" id="barcode-scanner-btn" style="width: 100%;">
                ‚ö° BARKOD/QR KOD TARAMAYI BA≈ûLAT
            </button>
        </div>

        <div id="interactive" class="viewport">
            <video style="width: 100%; height: 100%; object-fit: cover;" autoplay="true" preload="auto"></video>
            <div class="barcode-overlay-info">Kamerayƒ± Barkod/QR koda Tutun...</div>
        </div>
        <form id="sayim-form">
            {% csrf_token %}
            
            <label for="id_stok_kod">1. Stok Kodu (**ENTER** veya Tarama Sonrasƒ± Otomatik Dolum)</label>
            <input type="text" id="id_stok_kod" name="stok_kod" required autofocus>

            {% if gemini_available %}
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" id="gemini-camera-btn" style="background-color: #6a0dad; color: white; padding: 10px; border: none; border-radius: 6px; flex-grow: 1;">
                        üì∏ KAMERA ƒ∞LE √áEK (AI/OCR)
                    </button>
                    <button type="button" id="gemini-file-select-btn" style="background-color: #9400d3; color: white; padding: 10px; border: none; border-radius: 6px; flex-grow: 1;">
                        üìÅ DOSYADAN SE√á (AI/OCR)
                    </button>
                </div>
                <input type="file" id="gemini-file-input" name="image" accept="image/*" style="display:none;">
            {% endif %}

            <label for="id_parti_no">2. Parti No (Se√ßim / Opsiyonel)</label>
            <input type="text" id="id_parti_no" name="parti_no" list="parti-datalist">
            <datalist id="parti-datalist"></datalist>
            
            <label for="id_renk">3. Renk / Varyant (Se√ßim / Opsiyonel)</label>
            <input type="text" id="id_renk" name="renk" list="renk-datalist">
            <datalist id="renk-datalist"></datalist>

            <div id="last-sayim-label" class="info-box">Son Sayƒ±m: Bilinmiyor</div>
            
            <div id="urun-bilgi-label" class="info-box" style="margin-bottom: 20px;">√úr√ºn Bilgisi: Kodu Girin...</div>
            
            <label for="id_miktar">4. Sayƒ±m Miktarƒ±</label>
            <input type="number" step="any" id="id_miktar" name="miktar" required min="0">

            <button type="submit" id="kaydet-btn">KAYDET (**ENTER**)</button>
        </form>
    </div>

<script>
    const form = document.getElementById('sayim-form');
    const stokKodInput = document.getElementById('id_stok_kod');
    const partiNoInput = document.getElementById('id_parti_no');
    const renkInput = document.getElementById('id_renk');
    const miktarInput = document.getElementById('id_miktar');
    const urunBilgiLabel = document.getElementById('urun-bilgi-label');
    const lastSayimLabel = document.getElementById('last-sayim-label');
    const messageBox = document.getElementById('message-box');
    const DEPO_KODU = document.getElementById('depo-kodu').innerText;
    const SAYIM_EMRI_ID = {{ sayim_emri.pk }};
    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let debounceTimeout = null;

    // YENƒ∞ ELEMANLAR
    const geminiCameraBtn = document.getElementById('gemini-camera-btn');
    const geminiFileSelectBtn = document.getElementById('gemini-file-select-btn');
    const geminiFileInput = document.getElementById('gemini-file-input');
    const seriNoInput = document.getElementById('id_seri_no'); 
    
    // YENƒ∞ URL
    const AKILLI_ARAMA_URL = "{% url 'ajax_akilli_stok_ara' %}"; 
    
    // --- BARKOD TARAYICI SABƒ∞TLERƒ∞ ---
    const barcodeScannerBtn = document.getElementById('barcode-scanner-btn');
    const interactive = document.getElementById('interactive');
    let isScanning = false;
    const SCANNER_CONFIG = {
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: interactive,
            constraints: {
                facingMode: "environment"
            },
        },
        decoder: {
            readers: ["code_128_reader", "qr_code_reader", "ean_reader", "ean_8_reader", "code_39_reader"]
        },
        locate: true,
    };

    // Helper: Datalist doldurma
    function fillDatalist(datalistId, options) {
        const datalist = document.getElementById(datalistId);
        datalist.innerHTML = '';
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            datalist.appendChild(option);
        });
    }

    // --- AKILLI ARAMA FONKSƒ∞YONU ---
    function fetchStokInfo(triggerFocus = true) {
        const stokKod = stokKodInput.value;
        const partiNo = partiNoInput.value || '';
        const renk = renkInput.value || '';
        const seriNo = seriNoInput.value || ''; 

        if (stokKod.length < 3 && seriNo.length < 3) {
            urunBilgiLabel.textContent = '√úr√ºn Bilgisi: Kodu veya Seri No girin...';
            lastSayimLabel.textContent = 'Son Sayƒ±m: Bilinmiyor';
            return;
        }
        
        const params = new URLSearchParams({
            stok_kod: stokKod,
            parti_no: partiNo,
            renk: renk,
            seri_no: seriNo,
            depo_kod: DEPO_KODU
        });

        fetch(`${AKILLI_ARAMA_URL}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.found) {
                    stokKodInput.value = data.stok_kod;
                    partiNoInput.value = data.parti_no;
                    renkInput.value = data.renk;
                    
                    fillDatalist('parti-datalist', []);
                    fillDatalist('renk-datalist', []);
                    
                    urunBilgiLabel.textContent = `‚úÖ ${data.urun_bilgi}`;
                    lastSayimLabel.textContent = data.last_sayim ? `Son Sayƒ±m: ${data.last_sayim}` : 'Son Sayƒ±m: Hi√ß Sayƒ±lmadƒ±';

                    if (triggerFocus) {
                        miktarInput.focus();
                        miktarInput.select(); // Miktarƒ± otomatik se√ß
                    }
                    
                } else {
                    fillDatalist('parti-datalist', data.parti_varyantlar);
                    fillDatalist('renk-datalist', data.renk_varyantlar);

                    urunBilgiLabel.textContent = `‚ö†Ô∏è ${data.urun_bilgi}`;
                    lastSayimLabel.textContent = 'Son Sayƒ±m: Bilinmiyor';
                    
                    if (triggerFocus) {
                        const hasPartiVaryant = data.parti_varyantlar.some(v => v !== 'YOK');
                        const hasRenkVaryant = data.renk_varyantlar.some(v => v !== 'YOK');
                        if (hasPartiVaryant && (partiNoInput.value === 'YOK' || partiNoInput.value === '')) {
                            partiNoInput.focus();
                        } else if (hasRenkVaryant && (renkInput.value === 'YOK' || renkInput.value === '')) {
                            renkInput.focus();
                        } else {
                            miktarInput.focus();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Akƒ±llƒ± Stok arama hatasƒ±:', error);
                urunBilgiLabel.textContent = 'HATA: Stok bilgisi √ßekilemedi.';
            });
    }
    
    // --- BARKOD TARAYICI LOGIC'ƒ∞ (QuaggaJS) ---

    barcodeScannerBtn.addEventListener('click', () => {
        if (isScanning) {
            stopScanner();
        } else {
            startScanner();
        }
    });

    function startScanner() {
        stopScanner(); // √ñnceki taramayƒ± durdur
        isScanning = true;
        barcodeScannerBtn.textContent = '‚ùå TARAMAYI DURDUR';
        barcodeScannerBtn.style.backgroundColor = '#dc3545';
        interactive.style.display = 'block';
        messageBox.style.display = 'block';
        messageBox.className = 'info-box';
        messageBox.textContent = 'Kamera Ba≈ülatƒ±lƒ±yor. L√ºtfen izin verin.';

        Quagga.init(SCANNER_CONFIG, function (err) {
            if (err) {
                messageBox.className = 'info-box error';
                messageBox.textContent = `Barkod Ba≈ülatma Hatasƒ±: ${err.message}`;
                stopScanner();
                return;
            }
            Quagga.start();
            messageBox.textContent = 'Tarama Aktif. Barkoda Odaklayƒ±n.';
        });

        Quagga.onDetected(function (data) {
            if (data && data.codeResult && data.codeResult.code) {
                const barkodVerisi = data.codeResult.code.toUpperCase().trim();

                // T√ºm alanlarƒ± temizle
                stokKodInput.value = '';
                partiNoInput.value = '';
                renkInput.value = '';

                // Okunan veriyi Seri No olarak ata (Django'da Seri No aramasƒ±nƒ± √∂nceliklendirir)
                seriNoInput.value = barkodVerisi; 
                
                // Hƒ±zƒ± korumak i√ßin tarayƒ±cƒ±yƒ± durdur
                stopScanner();

                messageBox.className = 'info-box success';
                messageBox.textContent = `‚úÖ BARCODE OKUNDU: ${barkodVerisi}. Stok bilgisi getiriliyor...`;
                
                // Arama ve odaklama yap
                fetchStokInfo(true); 
            }
        });
    }

    function stopScanner() {
        if (isScanning) {
            Quagga.stop();
            isScanning = false;
            barcodeScannerBtn.textContent = '‚ö° BARKOD/QR KOD TARAMAYI BA≈ûLAT';
            barcodeScannerBtn.style.backgroundColor = '#007bff';
            interactive.style.display = 'none';
            messageBox.style.display = 'none';
        }
    }


    // --- GEMINI VE FORMU TEMƒ∞ZLEME MANTIƒûI ---
    if (geminiCameraBtn && geminiFileSelectBtn) {
        const checkUser = () => {
            if (document.getElementById('personel-adi').innerText === 'MISAFIR') {
                alert("L√ºtfen oturumu personel adƒ±nƒ±zla ba≈ülatƒ±n.");
                return false;
            }
            return true;
        };
        geminiCameraBtn.addEventListener('click', () => {
            if (!checkUser()) return;
            // Tarama a√ßƒ±ksa durdur
            if (isScanning) stopScanner(); 
            geminiFileInput.setAttribute('capture', 'environment');
            geminiFileInput.click();
        });
        geminiFileSelectBtn.addEventListener('click', () => {
            if (!checkUser()) return;
            // Tarama a√ßƒ±ksa durdur
            if (isScanning) stopScanner();
            geminiFileInput.removeAttribute('capture');
            geminiFileInput.click();
        });
    }

    if (geminiFileInput) {
        geminiFileInput.addEventListener('change', function() {
            if (this.files.length === 0) return;

            messageBox.style.display = 'block';
            messageBox.className = 'info-box';
            messageBox.textContent = 'G√∂rsel Y√ºklendi. Yapay Zek√¢ Analiz Ediyor...';
            
            // T√ºm inputlarƒ± ve gizli Seri No alanƒ±nƒ± temizle
            stokKodInput.value = '';
            partiNoInput.value = '';
            renkInput.value = '';
            seriNoInput.value = '';

            const formData = new FormData();
            formData.append('image', this.files[0]);
            formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

            fetch('{% url "gemini_parti_oku" %}', {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Analiz ba≈üarƒ±sƒ±z oldu.');
                    });
                }
                return response.json();
            })
            .then(data => {
                messageBox.className = 'info-box success';
                messageBox.textContent = `Gemini Ba≈üarƒ±lƒ±: Seri No: ${data.seri_no || 'YOK'}, Stok Kodu: ${data.stok_kod || 'YOK'}`;
                
                // Gemini'dan gelen veriyi form alanlarƒ±na ve gizli Seri No alanƒ±na ata.
                seriNoInput.value = data.seri_no || '';
                stokKodInput.value = data.stok_kod || '';
                partiNoInput.value = data.parti_no || '';
                renkInput.value = data.renk || '';

                // T√ºm veriler geldikten sonra AKILLI ARAMA'yƒ± tetikle
                if (data.seri_no || data.stok_kod) {
                    fetchStokInfo(true);
                } else {
                    stokKodInput.focus();
                }

            })
            .catch(error => {
                messageBox.className = 'info-box error';
                messageBox.textContent = `Yapay Zek√¢ Hatasƒ±: ${error.message}`;
            })
            .finally(() => {
                geminiFileInput.value = '';
            });
        });
    }

    // --- FORM ETKƒ∞LE≈ûƒ∞MLERƒ∞ ---
    stokKodInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        // Yazƒ±lƒ± giri≈üte taramayƒ± durdur
        if (isScanning) stopScanner(); 
        debounceTimeout = setTimeout(() => fetchStokInfo(false), 300);
    });
    
    stokKodInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(debounceTimeout);
            // Manuel Enter'da Seri No'yu temizle
            seriNoInput.value = ''; 
            fetchStokInfo(true); 
        }
    });

    partiNoInput.addEventListener('input', () => fetchStokInfo(false));
    renkInput.addEventListener('input', () => fetchStokInfo(false));
    
    partiNoInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            miktarInput.focus();
        }
    });
    renkInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            miktarInput.focus();
        }
    });
    

    // --- KAYDETME (SUBMIT) ƒ∞≈ûLEMƒ∞ (Tek Tƒ±kla Kaydetme Revizyonu) ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const miktar = miktarInput.value;
        
        // 1. KESƒ∞N KONTROL: Stok Kodu ve Miktar bo≈ü olmamalƒ±.
        if (!stokKodInput.value || miktar.trim() === '') {
            messageBox.style.display = 'block';
            messageBox.className = 'info-box error';
            messageBox.textContent = 'HATA: L√ºtfen Stok Kodu ve Miktarƒ± girin.';
            stokKodInput.focus();
            return; 
        }
        
        // ‚ö†Ô∏è KRƒ∞Tƒ∞K REVƒ∞ZYON: Onay pencereleri kaldƒ±rƒ±ldƒ±. Doƒürudan kayda ge√ßiliyor.
        
        const finalParti = partiNoInput.value.trim() === '' ? 'YOK' : partiNoInput.value;
        const finalRenk = renkInput.value.trim() === '' ? 'YOK' : renkInput.value;

        const payload = {
            stok_kod: stokKodInput.value,
            parti_no: finalParti,
            renk: finalRenk,
            miktar: miktar,
            depo_kod: DEPO_KODU,
            personel_adi: document.getElementById('personel-adi').innerText
        };
        
        messageBox.style.display = 'block';
        messageBox.className = 'info-box';
        messageBox.textContent = 'Kaydediliyor... L√ºtfen Bekleyin...';
        
        // Tarayƒ±cƒ± a√ßƒ±ksa durdur
        stopScanner();

        fetch(`/ajax/kaydet/${SAYIM_EMRI_ID}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || response.statusText);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                messageBox.className = 'info-box success';
                messageBox.textContent = `BA≈ûARILI! ${data.message} (Sistem: ${data.sistem_stok}, Sayƒ±lan: ${data.yeni_miktar})`;
                
                // Kayƒ±t ba≈üarƒ±lƒ±ysa t√ºm alanlarƒ± SIFIRLA
                stokKodInput.value = '';
                miktarInput.value = '';
                partiNoInput.value = '';   
                renkInput.value = '';      
                seriNoInput.value = ''; 
                
            } else {
                // Sunucudan gelen √∂zel hata mesajlarƒ±nƒ± g√∂ster
                throw new Error(data.message || 'Bilinmeyen Kayƒ±t Hatasƒ±');
            }
        })
        .catch(error => {
            messageBox.className = 'info-box error';
            messageBox.textContent = `Kayƒ±t Hatasƒ±: ${error.message}`;
        })
        .finally(() => {
            // ƒ∞≈ülem bittikten sonra daima Stok Kodu/Tarama alanƒ±na geri d√∂n
            stokKodInput.focus();
            // Yeni odaklama sonrasƒ± arka plan bilgisini g√ºncelle (tutarlƒ±lƒ±k i√ßin)
            setTimeout(() => fetchStokInfo(false), 500); 
        });
    });

</script>
</body>
</html>