<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Sayƒ±m Giri≈üi (Emir {{ sayim_emri.pk }})</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 1.1em; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1.2em; }
        #kaydet-btn { background-color: #28a745; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.4em; width: 100%; margin-top: 25px; }
        .info-box { padding: 10px; margin-top: 10px; border-radius: 5px; }
        #urun-bilgi-label { background-color: #e9ecef; color: #495057; font-size: 1em; }
        #last-sayim-label { background-color: #fff3cd; color: #856404; font-size: 0.9em; }
        #message-box { margin-top: 15px; padding: 15px; border-radius: 6px; font-weight: bold; display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Stok Sayƒ±m Giri≈üi</h1>
        <p>**PERSONEL**: <span id="personel-adi">{{ personel_adi }}</span> | **DEPO**: <span id="depo-kodu">{{ depo_kodu }}</span></p>
        <h2 style="color: darkred;">Emir: {{ sayim_emri.ad }} (ID: {{ sayim_emri.pk }})</h2>

        <div id="message-box" class="info-box"></div>
        
        <input type="hidden" id="id_seri_no" name="seri_no" value="">

        <form id="sayim-form">
            {% csrf_token %}
            
            <label for="id_stok_kod">1. Stok Kodu (**ENTER** veya Kamera)</label>
            <input type="text" id="id_stok_kod" name="stok_kod" required autofocus>

            {% if gemini_available %}
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" id="gemini-camera-btn" style="background-color: #6a0dad; color: white; padding: 10px; border: none; border-radius: 6px; flex-grow: 1;">
                        üì∏ KAMERA ƒ∞LE √áEK
                    </button>
                    <button type="button" id="gemini-file-select-btn" style="background-color: #9400d3; color: white; padding: 10px; border: none; border-radius: 6px; flex-grow: 1;">
                        üìÅ DOSYADAN SE√á
                    </button>
                </div>
                <input type="file" id="gemini-file-input" name="image" accept="image/*" style="display:none;">
            {% endif %}

            <label for="id_parti_no">2. Parti No (Se√ßim / Opsiyonel)</label>
            <input type="text" id="id_parti_no" name="parti_no" list="parti-datalist">
            <datalist id="parti-datalist"></datalist>
            
            <label for="id_renk">3. Renk / Varyant (Se√ßim / Opsiyonel)</label>
            <input type="text" id="id_renk" name="renk" list="renk-datalist">
            <datalist id="renk-datalist"></datalist>

            <div id="last-sayim-label" class="info-box">Son Sayƒ±m: Bilinmiyor</div>
            
            <div id="urun-bilgi-label" class="info-box" style="margin-bottom: 20px;">√úr√ºn Bilgisi: Kodu Girin...</div>
            
            <label for="id_miktar">4. Sayƒ±m Miktarƒ±</label>
            <input type="number" step="any" id="id_miktar" name="miktar" required min="0">

            <button type="submit" id="kaydet-btn">KAYDET (**ENTER**)</button>
        </form>
    </div>

<script>
    const form = document.getElementById('sayim-form');
    const stokKodInput = document.getElementById('id_stok_kod');
    const partiNoInput = document.getElementById('id_parti_no');
    const renkInput = document.getElementById('id_renk');
    const miktarInput = document.getElementById('id_miktar');
    const urunBilgiLabel = document.getElementById('urun-bilgi-label');
    const lastSayimLabel = document.getElementById('last-sayim-label');
    const messageBox = document.getElementById('message-box');
    const DEPO_KODU = document.getElementById('depo-kodu').innerText;
    const SAYIM_EMRI_ID = {{ sayim_emri.pk }};
    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let debounceTimeout = null;

    // YENƒ∞ ELEMANLAR
    const geminiCameraBtn = document.getElementById('gemini-camera-btn');
    const geminiFileSelectBtn = document.getElementById('gemini-file-select-btn');
    const geminiFileInput = document.getElementById('gemini-file-input');
    const seriNoInput = document.getElementById('id_seri_no'); // Yeni gizli Seri No alanƒ±

    // YENƒ∞ URL
    const AKILLI_ARAMA_URL = "{% url 'ajax_akilli_stok_ara' %}"; 

    // Helper: Datalist doldurma
    function fillDatalist(datalistId, options) {
        const datalist = document.getElementById(datalistId);
        datalist.innerHTML = '';
        
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            datalist.appendChild(option);
        });
    }

    // --- AKILLI ARAMA FONKSƒ∞YONU G√úNCELLENDƒ∞ (Seri No √ñncelikli) ---
    function fetchStokInfo(triggerFocus = true) {
        const stokKod = stokKodInput.value;
        const partiNo = partiNoInput.value || '';
        const renk = renkInput.value || '';
        const seriNo = seriNoInput.value || ''; // Gizli Seri No alanƒ±nƒ± kullan

        if (stokKod.length < 3 && seriNo.length < 3) {
            urunBilgiLabel.textContent = '√úr√ºn Bilgisi: Kodu veya Seri No girin...';
            lastSayimLabel.textContent = 'Son Sayƒ±m: Bilinmiyor';
            return;
        }
        
        // T√ºm parametreleri akƒ±llƒ± arama endpoint'ine g√∂nder
        const params = new URLSearchParams({
            stok_kod: stokKod,
            parti_no: partiNo,
            renk: renk,
            seri_no: seriNo,
            depo_kod: DEPO_KODU
        });

        // AKILLI ARAMA endpoint'ini √ßaƒüƒ±r
        fetch(`${AKILLI_ARAMA_URL}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.found) {
                    // Seri No veya Parti/Varyant ile bulundu
                    
                    // Alanlarƒ± veritabanƒ±ndan d√∂nen kesin verilerle doldur
                    stokKodInput.value = data.stok_kod;
                    partiNoInput.value = data.parti_no;
                    renkInput.value = data.renk;
                    
                    // Seri No ile bulunduƒüu i√ßin datalist'leri temizle
                    fillDatalist('parti-datalist', []);
                    fillDatalist('renk-datalist', []);
                    
                    urunBilgiLabel.textContent = `‚úÖ ${data.urun_bilgi}`;
                    lastSayimLabel.textContent = data.last_sayim ? `Son Sayƒ±m: ${data.last_sayim}` : 'Son Sayƒ±m: Hi√ß Sayƒ±lmadƒ±';

                    if (triggerFocus) {
                        miktarInput.focus();
                    }
                    
                } else {
                    // Seri No/Tam E≈üle≈üme bulunamadƒ±, sadece Stok Kodu ile varyantlar d√∂nd√º
                    
                    fillDatalist('parti-datalist', data.parti_varyantlar);
                    fillDatalist('renk-datalist', data.renk_varyantlar);

                    urunBilgiLabel.textContent = `‚ö†Ô∏è ${data.urun_bilgi}`;
                    lastSayimLabel.textContent = 'Son Sayƒ±m: Bilinmiyor';
                    
                    if (triggerFocus) {
                        // Odaklanma mantƒ±ƒüƒ± aynƒ± kalƒ±r
                        const hasPartiVaryant = data.parti_varyantlar.some(v => v !== 'YOK');
                        const hasRenkVaryant = data.renk_varyantlar.some(v => v !== 'YOK');
                        if (hasPartiVaryant && (partiNoInput.value === 'YOK' || partiNoInput.value === '')) {
                            partiNoInput.focus();
                        } else if (hasRenkVaryant && (renkInput.value === 'YOK' || renkInput.value === '')) {
                            renkInput.focus();
                        } else {
                            miktarInput.focus();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Akƒ±llƒ± Stok arama hatasƒ±:', error);
                urunBilgiLabel.textContent = 'HATA: Stok bilgisi √ßekilemedi.';
            });
    }

    // --- GEMINI ƒ∞≈ûLEME MANTIƒûI G√úNCELLENDƒ∞ ---
    if (geminiCameraBtn && geminiFileSelectBtn) {
        const checkUser = () => {
            if (document.getElementById('personel-adi').innerText === 'MISAFIR') {
                alert("L√ºtfen oturumu personel adƒ±nƒ±zla ba≈ülatƒ±n.");
                return false;
            }
            return true;
        };
        geminiCameraBtn.addEventListener('click', () => {
            if (!checkUser()) return;
            geminiFileInput.setAttribute('capture', 'environment');
            geminiFileInput.click();
        });
        geminiFileSelectBtn.addEventListener('click', () => {
            if (!checkUser()) return;
            geminiFileInput.removeAttribute('capture');
            geminiFileInput.click();
        });
    }

    if (geminiFileInput) {
        geminiFileInput.addEventListener('change', function() {
            if (this.files.length === 0) return;

            messageBox.style.display = 'block';
            messageBox.className = 'info-box';
            messageBox.textContent = 'G√∂rsel Y√ºklendi. Yapay Zek√¢ Analiz Ediyor...';
            
            // T√ºm inputlarƒ± ve gizli Seri No alanƒ±nƒ± temizle
            stokKodInput.value = '';
            partiNoInput.value = '';
            renkInput.value = '';
            seriNoInput.value = '';

            const formData = new FormData();
            formData.append('image', this.files[0]);
            formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

            fetch('{% url "gemini_parti_oku" %}', {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Analiz ba≈üarƒ±sƒ±z oldu.');
                    });
                }
                return response.json();
            })
            .then(data => {
                messageBox.className = 'info-box success';
                messageBox.textContent = `Gemini Ba≈üarƒ±lƒ±: Seri No: ${data.seri_no || 'YOK'}, Stok Kodu: ${data.stok_kod || 'YOK'}`;
                
                // Gemini'dan gelen veriyi form alanlarƒ±na ve gizli Seri No alanƒ±na ata.
                seriNoInput.value = data.seri_no || '';
                stokKodInput.value = data.stok_kod || '';
                partiNoInput.value = data.parti_no || '';
                renkInput.value = data.renk || '';

                // T√ºm veriler geldikten sonra AKILLI ARAMA'yƒ± tetikle
                if (data.seri_no || data.stok_kod) {
                    fetchStokInfo(true);
                } else {
                    stokKodInput.focus();
                }

            })
            .catch(error => {
                messageBox.className = 'info-box error';
                messageBox.textContent = `Yapay Zek√¢ Hatasƒ±: ${error.message}`;
            })
            .finally(() => {
                geminiFileInput.value = '';
            });
        });
    }
    // --- END GEMINI ƒ∞≈ûLEME MANTIƒûI ---

    // Stok Kodu Deƒüi≈ütiƒüinde Akƒ±llƒ± Aramayƒ± Y√ºkle (Debounce ile)
    stokKodInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => fetchStokInfo(false), 300);
    });
    
    // Stok Kodu, Parti ve Renk inputlarƒ±nda deƒüi≈üiklik olduƒüunda (ENTER veya manual giri≈ü)
    // AKILLI ARAMA'yƒ± tetikle ve odaklanmayƒ± ayarla
    stokKodInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(debounceTimeout);
            // Manuel giri≈ü varsa, Seri No'yu temizle ki Parti No devreye girsin.
            seriNoInput.value = ''; 
            fetchStokInfo(true); 
        }
    });

    partiNoInput.addEventListener('input', () => fetchStokInfo(false));
    renkInput.addEventListener('input', () => fetchStokInfo(false));
    
    // Parti ve Renk alanlarƒ±nda ENTER basƒ±ldƒ±ƒüƒ±nda miktar alanƒ±na odaklan
    partiNoInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            miktarInput.focus();
        }
    });
    renkInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            miktarInput.focus();
        }
    });
    

    // Formu Kaydetme (Submit)
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const miktar = miktarInput.value;
        
        if (!stokKodInput.value || !miktar) {
            alert('Stok Kodu ve Miktar alanlarƒ± bo≈ü bƒ±rakƒ±lamaz.');
            return;
        }
        
        if (!confirm(`Stok Kodu: ${stokKodInput.value}\nMiktar: ${miktar}\nKaydƒ± onaylƒ±yor musunuz?`)) {
             return; 
        }

        const finalParti = partiNoInput.value.trim() === '' ? 'YOK' : partiNoInput.value;
        const finalRenk = renkInput.value.trim() === '' ? 'YOK' : renkInput.value;

        const payload = {
            stok_kod: stokKodInput.value,
            parti_no: finalParti,
            renk: finalRenk,
            miktar: miktar,
            depo_kod: DEPO_KODU,
            personel_adi: document.getElementById('personel-adi').innerText
        };
        
        messageBox.style.display = 'block';
        messageBox.className = 'info-box';
        messageBox.textContent = 'Kaydediliyor... L√ºtfen Bekleyin...';
        
        fetch(`/ajax/kaydet/${SAYIM_EMRI_ID}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
             if (!response.ok) {
                 return response.json().then(errorData => {
                     throw new Error(errorData.message || response.statusText);
                 });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                messageBox.className = 'info-box success';
                messageBox.textContent = `BA≈ûARILI! ${data.message} (Sistem: ${data.sistem_stok}, Sayƒ±lan: ${data.yeni_miktar})`;
                
                // Formu temizle ve bir sonraki sayƒ±ma hazƒ±rla
                stokKodInput.value = '';
                miktarInput.value = '';
                partiNoInput.value = ''; 
                renkInput.value = '';     
                seriNoInput.value = ''; // Gizli Seri No'yu da temizle
                stokKodInput.focus();
                
                // Yeni bo≈ü stok kodu i√ßin bilgiyi g√ºncelle
                setTimeout(() => fetchStokInfo(false), 500); 

            } else if (data.action === 'NEW_STOCK') {
                 messageBox.className = 'info-box error';
                 messageBox.textContent = data.message + ' Manuel Giri≈ü gerekiyor!';
                 stokKodInput.focus();
                 
            } else {
                throw new Error(data.message || 'Bilinmeyen Kayƒ±t Hatasƒ±');
            }
        })
        .catch(error => {
            messageBox.className = 'info-box error';
            messageBox.textContent = `Kayƒ±t Hatasƒ±: ${error.message}`;
        });
    });

</script>
</body>
</html>